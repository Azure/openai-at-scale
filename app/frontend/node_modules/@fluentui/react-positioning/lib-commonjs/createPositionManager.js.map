{"version":3,"sources":["../lib/createPositionManager.js"],"sourcesContent":["import { computePosition } from '@floating-ui/dom';\nimport { debounce, writeArrowUpdates, writeContainerUpdates, getScrollParent } from './utils';\nimport { isHTMLElement } from '@fluentui/react-utilities';\n/**\n * @internal\n * @returns manager that handles positioning out of the react lifecycle\n */\nexport function createPositionManager(options) {\n  const {\n    container,\n    target,\n    arrow,\n    strategy,\n    middleware,\n    placement\n  } = options;\n  let isDestroyed = false;\n  if (!target || !container) {\n    return {\n      updatePosition: () => undefined,\n      dispose: () => undefined\n    };\n  }\n  let isFirstUpdate = true;\n  const scrollParents = new Set();\n  const targetWindow = container.ownerDocument.defaultView;\n  // When the container is first resolved, set position `fixed` to avoid scroll jumps.\n  // Without this scroll jumps can occur when the element is rendered initially and receives focus\n  Object.assign(container.style, {\n    position: 'fixed',\n    left: 0,\n    top: 0,\n    margin: 0\n  });\n  const forceUpdate = () => {\n    // debounced update can still occur afterwards\n    // early return to avoid memory leaks\n    if (isDestroyed) {\n      return;\n    }\n    if (isFirstUpdate) {\n      scrollParents.add(getScrollParent(container));\n      if (isHTMLElement(target)) {\n        scrollParents.add(getScrollParent(target));\n      }\n      scrollParents.forEach(scrollParent => {\n        scrollParent.addEventListener('scroll', updatePosition);\n      });\n      isFirstUpdate = false;\n    }\n    Object.assign(container.style, {\n      position: strategy\n    });\n    computePosition(target, container, {\n      placement,\n      middleware,\n      strategy\n    }).then(({\n      x,\n      y,\n      middlewareData,\n      placement: computedPlacement\n    }) => {\n      // Promise can still resolve after destruction\n      // early return to avoid applying outdated position\n      if (isDestroyed) {\n        return;\n      }\n      writeArrowUpdates({\n        arrow,\n        middlewareData\n      });\n      writeContainerUpdates({\n        container,\n        middlewareData,\n        placement: computedPlacement,\n        coordinates: {\n          x,\n          y\n        },\n        lowPPI: ((targetWindow === null || targetWindow === void 0 ? void 0 : targetWindow.devicePixelRatio) || 1) <= 1,\n        strategy\n      });\n    }).catch(err => {\n      // https://github.com/floating-ui/floating-ui/issues/1845\n      // FIXME for node > 14\n      // node 15 introduces promise rejection which means that any components\n      // tests need to be `it('', async () => {})` otherwise there can be race conditions with\n      // JSDOM being torn down before this promise is resolved so globals like `window` and `document` don't exist\n      // Unless all tests that ever use `usePositioning` are turned into async tests, any logging during testing\n      // will actually be counter productive\n      if (process.env.NODE_ENV === 'development') {\n        // eslint-disable-next-line no-console\n        console.error('[usePositioning]: Failed to calculate position', err);\n      }\n    });\n  };\n  const updatePosition = debounce(() => forceUpdate());\n  const dispose = () => {\n    isDestroyed = true;\n    if (targetWindow) {\n      targetWindow.removeEventListener('scroll', updatePosition);\n      targetWindow.removeEventListener('resize', updatePosition);\n    }\n    scrollParents.forEach(scrollParent => {\n      scrollParent.removeEventListener('scroll', updatePosition);\n    });\n  };\n  if (targetWindow) {\n    targetWindow.addEventListener('scroll', updatePosition);\n    targetWindow.addEventListener('resize', updatePosition);\n  }\n  // Update the position on initialization\n  updatePosition();\n  return {\n    updatePosition,\n    dispose\n  };\n}\n//# sourceMappingURL=createPositionManager.js.map"],"names":["createPositionManager","options","container","target","arrow","strategy","middleware","placement","isDestroyed","updatePosition","undefined","dispose","isFirstUpdate","scrollParents","Set","targetWindow","ownerDocument","defaultView","Object","assign","style","position","left","top","margin","forceUpdate","add","getScrollParent","isHTMLElement","forEach","scrollParent","addEventListener","computePosition","then","x","y","middlewareData","computedPlacement","writeArrowUpdates","writeContainerUpdates","coordinates","lowPPI","devicePixelRatio","catch","err","process","env","NODE_ENV","console","error","debounce","removeEventListener"],"mappings":";;;;+BAOgBA;;aAAAA;;qBAPgB;uBACoD;gCACtD;AAKvB,SAASA,sBAAsBC,OAAO,EAAE;IAC7C,MAAM,EACJC,UAAS,EACTC,OAAM,EACNC,MAAK,EACLC,SAAQ,EACRC,WAAU,EACVC,UAAS,EACV,GAAGN;IACJ,IAAIO,cAAc,KAAK;IACvB,IAAI,CAACL,UAAU,CAACD,WAAW;QACzB,OAAO;YACLO,gBAAgB,IAAMC;YACtBC,SAAS,IAAMD;QACjB;IACF,CAAC;IACD,IAAIE,gBAAgB,IAAI;IACxB,MAAMC,gBAAgB,IAAIC;IAC1B,MAAMC,eAAeb,UAAUc,aAAa,CAACC,WAAW;IACxD,oFAAoF;IACpF,gGAAgG;IAChGC,OAAOC,MAAM,CAACjB,UAAUkB,KAAK,EAAE;QAC7BC,UAAU;QACVC,MAAM;QACNC,KAAK;QACLC,QAAQ;IACV;IACA,MAAMC,cAAc,IAAM;QACxB,8CAA8C;QAC9C,qCAAqC;QACrC,IAAIjB,aAAa;YACf;QACF,CAAC;QACD,IAAII,eAAe;YACjBC,cAAca,GAAG,CAACC,IAAAA,sBAAe,EAACzB;YAClC,IAAI0B,IAAAA,6BAAa,EAACzB,SAAS;gBACzBU,cAAca,GAAG,CAACC,IAAAA,sBAAe,EAACxB;YACpC,CAAC;YACDU,cAAcgB,OAAO,CAACC,CAAAA,eAAgB;gBACpCA,aAAaC,gBAAgB,CAAC,UAAUtB;YAC1C;YACAG,gBAAgB,KAAK;QACvB,CAAC;QACDM,OAAOC,MAAM,CAACjB,UAAUkB,KAAK,EAAE;YAC7BC,UAAUhB;QACZ;QACA2B,IAAAA,oBAAe,EAAC7B,QAAQD,WAAW;YACjCK;YACAD;YACAD;QACF,GAAG4B,IAAI,CAAC,CAAC,EACPC,EAAC,EACDC,EAAC,EACDC,eAAc,EACd7B,WAAW8B,kBAAiB,EAC7B,GAAK;YACJ,8CAA8C;YAC9C,mDAAmD;YACnD,IAAI7B,aAAa;gBACf;YACF,CAAC;YACD8B,IAAAA,wBAAiB,EAAC;gBAChBlC;gBACAgC;YACF;YACAG,IAAAA,4BAAqB,EAAC;gBACpBrC;gBACAkC;gBACA7B,WAAW8B;gBACXG,aAAa;oBACXN;oBACAC;gBACF;gBACAM,QAAQ,AAAC,CAAA,AAAC1B,CAAAA,iBAAiB,IAAI,IAAIA,iBAAiB,KAAK,IAAI,KAAK,IAAIA,aAAa2B,gBAAgB,AAAD,KAAM,CAAA,KAAM;gBAC9GrC;YACF;QACF,GAAGsC,KAAK,CAACC,CAAAA,MAAO;YACd,yDAAyD;YACzD,sBAAsB;YACtB,uEAAuE;YACvE,wFAAwF;YACxF,4GAA4G;YAC5G,0GAA0G;YAC1G,sCAAsC;YACtC,IAAIC,QAAQC,GAAG,CAACC,QAAQ,KAAK,eAAe;gBAC1C,sCAAsC;gBACtCC,QAAQC,KAAK,CAAC,kDAAkDL;YAClE,CAAC;QACH;IACF;IACA,MAAMnC,iBAAiByC,IAAAA,eAAQ,EAAC,IAAMzB;IACtC,MAAMd,UAAU,IAAM;QACpBH,cAAc,IAAI;QAClB,IAAIO,cAAc;YAChBA,aAAaoC,mBAAmB,CAAC,UAAU1C;YAC3CM,aAAaoC,mBAAmB,CAAC,UAAU1C;QAC7C,CAAC;QACDI,cAAcgB,OAAO,CAACC,CAAAA,eAAgB;YACpCA,aAAaqB,mBAAmB,CAAC,UAAU1C;QAC7C;IACF;IACA,IAAIM,cAAc;QAChBA,aAAagB,gBAAgB,CAAC,UAAUtB;QACxCM,aAAagB,gBAAgB,CAAC,UAAUtB;IAC1C,CAAC;IACD,wCAAwC;IACxCA;IACA,OAAO;QACLA;QACAE;IACF;AACF,EACA,iDAAiD"}