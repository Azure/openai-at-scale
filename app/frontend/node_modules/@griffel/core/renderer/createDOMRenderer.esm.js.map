{"version":3,"file":"createDOMRenderer.esm.js","sources":["../../../../packages/core/src/renderer/createDOMRenderer.ts"],"sourcesContent":["import { injectDevTools, isDevToolsEnabled, debugData } from '../devtools';\nimport { normalizeCSSBucketEntry } from '../runtime/utils/normalizeCSSBucketEntry';\nimport { GriffelRenderer, StyleBucketName } from '../types';\nimport { getStyleSheetForBucket } from './getStyleSheetForBucket';\n\nlet lastIndex = 0;\n\nexport interface CreateDOMRendererOptions {\n  /**\n   * If specified, a renderer will insert created style tags after this element.\n   */\n  insertionPoint?: HTMLElement;\n\n  /**\n   * A map of attributes that's passed to the generated style elements. Is useful to set \"nonce\" attribute.\n   *\n   * @see https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/nonce\n   */\n  styleElementAttributes?: Record<string, string>;\n\n  /**\n   * A filter run before CSS rule insertion to systematically remove CSS rules at render time.\n   * This can be used to forbid specific rules from being written to the style sheet at run time without\n   * affecting build time styles.\n   *\n   * ⚠️ Keep the filter as performant as possible to avoid negative performance impacts to your application.\n   * ⚠️ This API is unstable and can be removed from the library at any time.\n   */\n  unstable_filterCSSRule?: (cssRule: string) => boolean;\n\n  /**\n   * @param a - media query\n   * @param b - media query\n   * @returns positive number if a > b or negative number if a < b\n   */\n  compareMediaQueries?: (a: string, b: string) => number;\n}\n\n/** @internal */\nexport const defaultCompareMediaQueries = (a: string, b: string) => (a < b ? -1 : a > b ? 1 : 0);\n\n/**\n * Creates a new instances of a renderer.\n *\n * @public\n */\nexport function createDOMRenderer(\n  targetDocument: Document | undefined = typeof document === 'undefined' ? undefined : document,\n  options: CreateDOMRendererOptions = {},\n): GriffelRenderer {\n  const {\n    unstable_filterCSSRule,\n    insertionPoint,\n    styleElementAttributes,\n    compareMediaQueries = defaultCompareMediaQueries,\n  } = options;\n  const renderer: GriffelRenderer = {\n    insertionCache: {},\n    stylesheets: {},\n    styleElementAttributes: Object.freeze(styleElementAttributes),\n    compareMediaQueries,\n\n    id: `d${lastIndex++}`,\n\n    insertCSSRules(cssRules) {\n      // eslint-disable-next-line guard-for-in\n      for (const styleBucketName in cssRules) {\n        const cssRulesForBucket = cssRules[styleBucketName as StyleBucketName]!;\n\n        // This is a hot path in rendering styles: \".length\" is cached in \"l\" var to avoid accesses the property\n        for (let i = 0, l = cssRulesForBucket.length; i < l; i++) {\n          const [ruleCSS, metadata] = normalizeCSSBucketEntry(cssRulesForBucket[i]);\n          const sheet = getStyleSheetForBucket(\n            styleBucketName as StyleBucketName,\n            targetDocument,\n            insertionPoint || null,\n            renderer,\n            metadata,\n          );\n\n          if (renderer.insertionCache[ruleCSS]) {\n            continue;\n          }\n\n          renderer.insertionCache[ruleCSS] = styleBucketName as StyleBucketName;\n\n          if (process.env.NODE_ENV !== 'production' && isDevToolsEnabled) {\n            debugData.addCSSRule(ruleCSS);\n          }\n\n          try {\n            if (unstable_filterCSSRule) {\n              if (unstable_filterCSSRule(ruleCSS)) {\n                sheet.insertRule(ruleCSS);\n              }\n            } else {\n              sheet.insertRule(ruleCSS);\n            }\n          } catch (e) {\n            // We've disabled these warnings due to false-positive errors with browser prefixes\n            if (process.env.NODE_ENV !== 'production' && !ignoreSuffixesRegex.test(ruleCSS)) {\n              // eslint-disable-next-line no-console\n              console.error(`There was a problem inserting the following rule: \"${ruleCSS}\"`, e);\n            }\n          }\n        }\n      }\n    },\n  };\n\n  if (targetDocument && process.env.NODE_ENV !== 'production' && isDevToolsEnabled) {\n    injectDevTools(targetDocument);\n  }\n\n  return renderer;\n}\n\n/**\n * Suffixes to be ignored in case of error\n */\nconst ignoreSuffixes = [\n  '-moz-placeholder',\n  '-moz-focus-inner',\n  '-moz-focusring',\n  '-ms-input-placeholder',\n  '-moz-read-write',\n  '-moz-read-only',\n].join('|');\nconst ignoreSuffixesRegex = new RegExp(`:(${ignoreSuffixes})`);\n"],"names":["lastIndex","defaultCompareMediaQueries","a","b","createDOMRenderer","targetDocument","document","undefined","options","unstable_filterCSSRule","insertionPoint","styleElementAttributes","compareMediaQueries","renderer","insertionCache","stylesheets","Object","freeze","id","insertCSSRules","cssRules","styleBucketName","cssRulesForBucket","i","l","length","ruleCSS","metadata","normalizeCSSBucketEntry","sheet","getStyleSheetForBucket","process","env","NODE_ENV","isDevToolsEnabled","debugData","addCSSRule","insertRule","e","ignoreSuffixesRegex","test","console","error","injectDevTools","ignoreSuffixes","join","RegExp"],"mappings":";;;;;;AAKA,IAAIA,SAAS,GAAG,CAAC;AAiCjB;MACaC,0BAA0B,GAAG,CAACC,CAAS,EAAEC,CAAS,KAAMD,CAAC,GAAGC,CAAC,GAAG,CAAC,CAAC,GAAGD,CAAC,GAAGC,CAAC,GAAG,CAAC,GAAG;AAE9F;;;;;SAKgBC,iBAAiB,CAC/BC,iBAAuC,OAAOC,QAAQ,KAAK,WAAW,GAAGC,SAAS,GAAGD,QAAQ,EAC7FE,UAAoC,EAAE;EAEtC,MAAM;IACJC,sBAAsB;IACtBC,cAAc;IACdC,sBAAsB;IACtBC,mBAAmB,GAAGX;GACvB,GAAGO,OAAO;EACX,MAAMK,QAAQ,GAAoB;IAChCC,cAAc,EAAE,EAAE;IAClBC,WAAW,EAAE,EAAE;IACfJ,sBAAsB,EAAEK,MAAM,CAACC,MAAM,CAACN,sBAAsB,CAAC;IAC7DC,mBAAmB;IAEnBM,EAAE,MAAMlB,SAAS,IAAI;IAErBmB,cAAc,CAACC,QAAQ;;MAErB,KAAK,MAAMC,eAAe,IAAID,QAAQ,EAAE;QACtC,MAAME,iBAAiB,GAAGF,QAAQ,CAACC,eAAkC,CAAE;;QAGvE,KAAK,IAAIE,CAAC,GAAG,CAAC,EAAEC,CAAC,GAAGF,iBAAiB,CAACG,MAAM,EAAEF,CAAC,GAAGC,CAAC,EAAED,CAAC,EAAE,EAAE;UACxD,MAAM,CAACG,OAAO,EAAEC,QAAQ,CAAC,GAAGC,uBAAuB,CAACN,iBAAiB,CAACC,CAAC,CAAC,CAAC;UACzE,MAAMM,KAAK,GAAGC,sBAAsB,CAClCT,eAAkC,EAClChB,cAAc,EACdK,cAAc,IAAI,IAAI,EACtBG,QAAQ,EACRc,QAAQ,CACT;UAED,IAAId,QAAQ,CAACC,cAAc,CAACY,OAAO,CAAC,EAAE;YACpC;;UAGFb,QAAQ,CAACC,cAAc,CAACY,OAAO,CAAC,GAAGL,eAAkC;UAErE,IAAIU,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,IAAIC,iBAAiB,EAAE;YAC9DC,SAAS,CAACC,UAAU,CAACV,OAAO,CAAC;;UAG/B,IAAI;YACF,IAAIjB,sBAAsB,EAAE;cAC1B,IAAIA,sBAAsB,CAACiB,OAAO,CAAC,EAAE;gBACnCG,KAAK,CAACQ,UAAU,CAACX,OAAO,CAAC;;aAE5B,MAAM;cACLG,KAAK,CAACQ,UAAU,CAACX,OAAO,CAAC;;WAE5B,CAAC,OAAOY,CAAC,EAAE;;YAEV,IAAIP,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,IAAI,CAACM,mBAAmB,CAACC,IAAI,CAACd,OAAO,CAAC,EAAE;;cAE/Ee,OAAO,CAACC,KAAK,uDAAuDhB,UAAU,EAAEY,CAAC,CAAC;;;;;;GAM7F;EAED,IAAIjC,cAAc,IAAI0B,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,IAAIC,iBAAiB,EAAE;IAChFS,cAAc,CAACtC,cAAc,CAAC;;EAGhC,OAAOQ,QAAQ;AACjB;AAEA;;;AAGA,MAAM+B,cAAc,gBAAG,CACrB,kBAAkB,EAClB,kBAAkB,EAClB,gBAAgB,EAChB,uBAAuB,EACvB,iBAAiB,EACjB,gBAAgB,CACjB,CAACC,IAAI,CAAC,GAAG,CAAC;AACX,MAAMN,mBAAmB,gBAAG,IAAIO,MAAM,MAAMF,iBAAiB,CAAC;;;;"}