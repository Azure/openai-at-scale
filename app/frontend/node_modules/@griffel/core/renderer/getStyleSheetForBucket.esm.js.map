{"version":3,"file":"getStyleSheetForBucket.esm.js","sources":["../../../../packages/core/src/renderer/getStyleSheetForBucket.ts"],"sourcesContent":["import { DATA_BUCKET_ATTR } from '../constants';\nimport { GriffelRenderer, IsomorphicStyleSheet, StyleBucketName } from '../types';\nimport { createIsomorphicStyleSheet } from './createIsomorphicStyleSheet';\n\n/**\n * Ordered style buckets using their short pseudo name.\n *\n * @internal\n */\nexport const styleBucketOrdering: StyleBucketName[] = [\n  // reset styles\n  'r',\n  // catch-all\n  'd',\n  // link\n  'l',\n  // visited\n  'v',\n  // focus-within\n  'w',\n  // focus\n  'f',\n  // focus-visible\n  'i',\n  // hover\n  'h',\n  // active\n  'a',\n  // keyframes\n  'k',\n  // at-rules\n  't',\n  // @media rules\n  'm',\n];\n\n// avoid repeatedly calling `indexOf`to determine order during new insertions\nconst styleBucketOrderingMap = styleBucketOrdering.reduce((acc, cur, j) => {\n  acc[cur as StyleBucketName] = j;\n  return acc;\n}, {} as Record<StyleBucketName, number>);\n\n/**\n * Lazily adds a `<style>` bucket to the `<head>`. This will ensure that the style buckets are ordered.\n */\nexport function getStyleSheetForBucket(\n  bucketName: StyleBucketName,\n  targetDocument: Document | undefined,\n  insertionPoint: HTMLElement | null,\n  renderer: GriffelRenderer,\n  metadata: Record<string, unknown> = {},\n): IsomorphicStyleSheet {\n  const isMediaBucket = bucketName === 'm';\n  const stylesheetKey: StyleBucketName | string = isMediaBucket ? ((bucketName + metadata['m']) as string) : bucketName;\n\n  if (!renderer.stylesheets[stylesheetKey]) {\n    const tag: HTMLStyleElement | undefined = targetDocument && targetDocument.createElement('style');\n    const stylesheet = createIsomorphicStyleSheet(tag, bucketName, {\n      ...renderer.styleElementAttributes,\n      ...(isMediaBucket && { media: metadata['m'] as string }),\n    });\n\n    renderer.stylesheets[stylesheetKey] = stylesheet;\n\n    if (targetDocument && tag) {\n      targetDocument.head.insertBefore(\n        tag,\n        findInsertionPoint(targetDocument, insertionPoint, bucketName, renderer, metadata),\n      );\n    }\n  }\n\n  return renderer.stylesheets[stylesheetKey]!;\n}\n\n/**\n * Finds an element before which the new bucket style element should be inserted following the bucket sort order.\n *\n * @param targetDocument - A document\n * @param insertionPoint - An element that will be used as an initial insertion point\n * @param targetBucket - The bucket that should be inserted to DOM\n * @param renderer - Griffel renderer\n * @param metadata - metadata for CSS rule\n * @returns - Smallest style element with greater sort order than the current bucket\n */\nfunction findInsertionPoint(\n  targetDocument: Document,\n  insertionPoint: HTMLElement | null,\n  targetBucket: StyleBucketName,\n  renderer: GriffelRenderer,\n  metadata?: Record<string, unknown>,\n): Node | null {\n  const targetOrder = styleBucketOrderingMap[targetBucket];\n\n  // Similar to javascript sort comparators where\n  // a positive value is increasing sort order\n  // a negative value is decreasing sort order\n  let comparer: (el: HTMLStyleElement) => number = el =>\n    targetOrder - styleBucketOrderingMap[el.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName];\n\n  let styleElements = targetDocument.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}]`);\n\n  if (targetBucket === 'm' && metadata) {\n    const mediaElements = targetDocument.head.querySelectorAll<HTMLStyleElement>(\n      `[${DATA_BUCKET_ATTR}=\"${targetBucket}\"]`,\n    );\n\n    // only reduce the scope of the search and change comparer\n    // if there are other media buckets already on the page\n    if (mediaElements.length) {\n      styleElements = mediaElements;\n      comparer = (el: HTMLStyleElement) => renderer.compareMediaQueries(metadata['m'] as string, el.media);\n    }\n  }\n\n  const length = styleElements.length;\n  let index = length - 1;\n\n  while (index >= 0) {\n    const styleElement = styleElements.item(index);\n\n    if (comparer(styleElement) > 0) {\n      return styleElement.nextSibling;\n    }\n\n    index--;\n  }\n\n  if (length > 0) {\n    return styleElements.item(0);\n  }\n\n  return insertionPoint ? insertionPoint.nextSibling : null;\n}\n"],"names":["styleBucketOrdering","styleBucketOrderingMap","reduce","acc","cur","j","getStyleSheetForBucket","bucketName","targetDocument","insertionPoint","renderer","metadata","isMediaBucket","stylesheetKey","stylesheets","tag","createElement","stylesheet","createIsomorphicStyleSheet","styleElementAttributes","media","head","insertBefore","findInsertionPoint","targetBucket","targetOrder","comparer","el","getAttribute","DATA_BUCKET_ATTR","styleElements","querySelectorAll","mediaElements","length","compareMediaQueries","index","styleElement","item","nextSibling"],"mappings":"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"}